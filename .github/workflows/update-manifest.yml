name: Update Manifest.json on Release

on:
  release:
    types: [published, edited]
  workflow_dispatch:
    inputs:
      tag:
        description: "対象のReleaseタグ（例: 2025_1218_1940）"
        required: true

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_REPO: ${{ github.repository }}

    steps:
      - name: Set variables
        run: |
          set -euo pipefail
          echo "REPO=${{ github.repository }}" >> "$GITHUB_ENV"

          if [ -n "${{ github.event.inputs.tag }}" ]; then
            # 手動実行
            echo "TAG=${{ github.event.inputs.tag }}" >> "$GITHUB_ENV"

            # タグからRelease情報を引いてタイトル(name)を取得（失敗しても落とさず空にする）
            gh api "repos/${{ github.repository }}/releases/tags/${{ github.event.inputs.tag }}" > release.json 2>/dev/null || true

            python3 - <<`PY'
            import json, os, pathlib
            title = ""
            p = pathlib.Path("release.json")
            if p.exists() and p.stat().st_size > 0:
                try:
                    obj = json.loads(p.read_text(encoding="utf-8"))
                    title = obj.get("name") or ""
                except Exception:
                    title = ""
            with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
                f.write(f"RELEASE_TITLE={title}\n")
            print("RELEASE_TITLE =", title)
            PY
          else
            # Releaseイベント
            echo "TAG=${{ github.event.release.tag_name }}" >> "$GITHUB_ENV"
            echo "RELEASE_TITLE=${{ github.event.release.name }}" >> "$GITHUB_ENV"
          fi

      - name: Find previous release tag (for base manifest)
        run: |
          set -euo pipefail
          gh api "repos/$REPO/releases?per_page=30" > releases.json

          python3 - <<'PY'
          import json, os
          tag = os.environ["TAG"]
          with open("releases.json", "r", encoding="utf-8") as f:
              rels = json.load(f)

          prev = ""
          for r in rels:
              if r.get("draft") or r.get("prerelease"):
                  continue
              if r.get("tag_name") == tag:
                  continue
              prev = r.get("tag_name", "")
              if prev:
                  break

          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
              f.write(f"PREV_TAG={prev}\n")
          print("PREV_TAG =", prev)
          PY

      - name: Download base manifest from previous release (if exists)
        run: |
          set -euo pipefail
          mkdir -p base
          if [ -n "${PREV_TAG:-}" ]; then
            gh release download "$PREV_TAG" --pattern "Manifest.json" --dir base --repo "$REPO" || true
          fi

      - name: Download current release assets (if they exist)
        run: |
          set -euo pipefail
          mkdir -p cur
          gh release download "$TAG" --pattern "Build.zip" --dir cur --repo "$REPO" || true
          gh release download "$TAG" --pattern "Launcher.ps1" --dir cur --repo "$REPO" || true

      - name: Generate Manifest.json
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, json, hashlib, pathlib, re

          repo  = os.environ["REPO"]
          tag   = os.environ["TAG"]
          title = os.environ.get("RELEASE_TITLE", "") or ""

          latest_manifest_url = f"https://github.com/{repo}/releases/latest/download/Manifest.json"
          base_path    = pathlib.Path("base/Manifest.json")
          cur_build    = pathlib.Path("cur/Build.zip")
          cur_launcher = pathlib.Path("cur/Launcher.ps1")

          def sha256_hex(b: bytes) -> str:
              return hashlib.sha256(b).hexdigest()

          def version_from_title(title_str: str, kind: str) -> str:
              """
              例:
                title="Build_1.23"    kind="Build"    -> "1.23"
                title="Launcher_1.5"  kind="Launcher" -> "1.5"
              余計な文字が付いてても kind_数字 を含めばOK
              """
              if not title_str:
                  return ""
              m = re.search(rf'\b{re.escape(kind)}[_\s-]*([0-9]+(?:\.[0-9]+)*)', title_str)
              return m.group(1) if m else ""

          if base_path.exists():
              manifest = json.loads(base_path.read_text(encoding="utf-8"))
          else:
              manifest = {
                  "manifestUrl": latest_manifest_url,
                  "build":    {"version": "", "url": "", "sha256": ""},
                  "launcher": {"version": "", "url": "", "sha256": ""}
              }

          manifest["manifestUrl"] = latest_manifest_url
          manifest.setdefault("build", {})
          manifest.setdefault("launcher", {})
          for k in ["version", "url", "sha256"]:
              manifest["build"].setdefault(k, "")
              manifest["launcher"].setdefault(k, "")

          # Build.zip がこのReleaseにあるなら更新
          if cur_build.exists():
              b = cur_build.read_bytes()
              v = version_from_title(title, "Build")
              if v:
                  manifest["build"]["version"] = v
              # vが取れない場合は前のversionを維持
              manifest["build"]["url"]    = f"https://github.com/{repo}/releases/download/{tag}/Build.zip"
              manifest["build"]["sha256"] = sha256_hex(b)

          # Launcher.ps1 がこのReleaseにあるなら更新（DLされる“そのまま”のsha256）
          if cur_launcher.exists():
              b = cur_launcher.read_bytes()
              v = version_from_title(title, "Launcher")
              if v:
                  manifest["launcher"]["version"] = v
              # vが取れない場合は前のversionを維持
              manifest["launcher"]["url"]    = f"https://github.com/{repo}/releases/download/{tag}/Launcher.ps1"
              manifest["launcher"]["sha256"] = sha256_hex(b)

          out = json.dumps(manifest, ensure_ascii=False, indent=2) + "\n"
          pathlib.Path("Manifest.json").write_text(out, encoding="utf-8")
          print("TAG =", tag)
          print("RELEASE_TITLE =", title)
          print(out)
          PY

      - name: Upload Manifest.json to this release
        run: |
          set -euo pipefail
          gh release upload "$TAG" Manifest.json --clobber --repo "$REPO"
